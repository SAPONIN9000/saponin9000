var Sparebeat = Sparebeat || {
  map: null,
  bgm: null,

  loadFile: function(filePath, fileType, callback) {
    var request = new XMLHttpRequest();
    request.open('GET', filePath, true);
    request.responseType = fileType;
    request.onload = function() {
      if (request.readyState === 4) {
        if (request.status === 200) {
          callback(request);
        } else if (request.status === 404) {
          alert('Error.');
        }
      }
    };
    request.onerror = function(e) {
      alert(e);
    };
    request.send();
  },

  loadFileWithProgressBar: function(filePath, fileType, callback) {
    var request = new XMLHttpRequest();
    request.open('GET', filePath, true);
    request.responseType = fileType;
    request.onload = function() {
      if (request.readyState === 4) {
        if (request.status === 200) {
          callback(request);
        } else if (request.status === 404) {
          alert('Error.');
        }
      }
    };
    request.addEventListener('progress', function(e) {
      var iframe = document.getElementById('sparebeat').contentWindow;
      var message = {
        id: 'sparebeat_progress',
        total: e.total,
        loaded: e.loaded
      };
      iframe.postMessage(JSON.stringify(message), 'https://sparebeat.com');
    });
    request.onerror = function(e) {
      alert(e);
    };
    request.send();
  },

  load: function(mapPath, bgmPath) {
    var self = this;
    setTimeout(function() {
      self.loadFile(mapPath, 'json', function(request) {
        self.map = request.response;
        self.progress();
      });
      self.loadFileWithProgressBar(bgmPath, 'arraybuffer', function(request) {
        self.bgm = request.response;
        self.progress();
      });
    }, 1000);
  },

  autoload: function() {
    this.load('map.json', 'music.mp3');
  },

  progress: function() {
    if (typeof this.progress.count === 'undefined') {
      this.progress.count = 0;
    }
    this.progress.count++;
    if (this.progress.count >= 2) {
      var iframe = document.getElementById('sparebeat').contentWindow;
      var message = {
        id: 'sparebeat',
        map: this.map,
        bgm: this.arrayBufferToBase64(this.bgm)
      };
      iframe.postMessage(JSON.stringify(message), 'https://sparebeat.com');
    }
  },

  arrayBufferToBase64: function(buffer) {
    var binary = '';
    var bytes = new Uint8Array(buffer);
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
  },

  getFullPath: function(relativePath) {
    var anchor = document.createElement('a');
    anchor.href = relativePath;
    return anchor.href;
  }
};
